/*
    This file is part of tau-vulnerability.
    Copyright (C) 2019-2020  Emir Turkes

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

    Emir Turkes can be contacted at emir.turkes@eturkes.com
*/

digraph {
    label="Single-cell RNAseq Workflow";
    rankdir=LR;
    node [shape=box];
    {
        rank=same;
        "Pre-processing" -> is_case_control [style=invis];
        is_case_control -> is_single_nuc2 [style=invis];
        is_single_nuc2 -> is_droplet [style=invis];
    }

    is_single_nuc[shape=ellipse, label="Is single-nucleus?"];
    is_case_control[shape=ellipse, label="Is case/control?"];
    is_single_nuc2[shape=ellipse, label="Is single-nucleus?"];
    is_droplet[shape=ellipse, label="Is droplet-based?"];

    "Pre-processing" -> "Gene counts";
    "Gene counts"-> is_single_nuc;
    is_single_nuc -> "SingleCellExperiment (SCE) object" [label="No"]
    is_single_nuc -> "Include introns" [label="Yes"];
    "Include introns" -> "SingleCellExperiment (SCE) object"; 
    "Pre-processing" -> "Metadata"
    "Metadata" -> "SingleCellExperiment (SCE) object";

    "SingleCellExperiment (SCE) object" -> is_case_control;
    is_case_control -> "Identify mitochondrial (MT) genes" [label="No"];
    is_case_control -> "Subset to controls" [label="Yes"];
    "Subset to controls" -> "Identify mitochondrial (MT) genes";

    "Identify mitochondrial (MT) genes" -> "Add per cell QC metrics";
    "Add per cell QC metrics" -> is_single_nuc2;
    is_single_nuc2 -> "Remove outliers (more than 3 MADs)" [label="No"];
    is_single_nuc2 -> "Remove MT genes" [label="Yes"];
    "Remove MT genes" -> "Remove outliers (more than 3 MADs)";

    "Remove outliers (more than 3 MADs)" -> is_droplet;
    is_droplet -> "Add per feature QC metrics" [label="No"];
    is_droplet -> "Remove empty droplets" [label="Yes"];
    "Remove empty droplets" -> "Add per feature QC metrics";

    "Add per feature QC metrics" -> "Remove unexpressed features";
}
