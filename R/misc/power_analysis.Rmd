---
title:
  'Power Analysis - `r unlist(strsplit(getwd(), "/"))[length(unlist(strsplit(getwd(), "/"))) - 2]`'
author:
  - name: "Emir Turkes [emir.turkes@eturkes.com]"
  - name: "UK Dementia Research Institute at UCL"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(
    inputFile,
    encoding = encoding,
    output_file = file.path(
      "..", "..", "results",
      unlist(strsplit(getwd(), "/"))[length(unlist(strsplit(getwd(), "/")))], "power-analysis.html"
    )
  )})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of the [Tau Vulnerability Project](https://github.com/eturkes/tau-vulnerability).*

```{r}
# Load in necessary boilerplate and libraries.
# --------------------------------------------

#    This file is part of tau-vulnerability.
#    Copyright (C) 2019-2021  Emir Turkes, UK DRI at UCL, Columbia University Medical Center
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at emir.turkes@eturkes.com

packages <- c("conflicted", "scPower", "SingleCellExperiment", "biomaRt")
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))

assets_dir <- file.path("..", "..", "assets") # Backed up data.

cache_dir <- file.path("..", "..", "cache", "misc", "power-analysis")
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

knitr::opts_chunk$set(dpi = 300)
# ------------------------------------------------
# ----------------------------------------------------------
```

```{r}
sce <- readRDS(file.path(cache_dir, "processed_sce.rds"))
sce

DEGs <- readRDS(file.path(cache_dir, "all_DE.rds"))
head(DEGs)

limma_results <- readRDS(file.path(cache_dir, "limma.rds"))
limma_results <- limma_results[rownames(limma_results) %in% DEGs, ]
head(limma_results)

gene_ranks <- gene.rank.calculation(logcounts(sce), DEGs)

mart <- useEnsembl("ensembl", "hsapiens_gene_ensembl")
attributes <- c("external_gene_name", "ensembl_gene_id")
gene_anno <- getBM(attributes, "ensembl_gene_id", gene_ranks$gene_symbol, mart)
gene_anno <- gene_anno[order(match(gene_anno$ensembl_gene_id, gene_ranks$gene_symbol)), ]
gene_ranks$external_gene_name <- gene_anno$external_gene_name

limma_results <- limma_results[order(match(rownames(limma_results), gene_ranks$gene_symbol)), ]
gene_ranks$logFC <- limma_results$logFC

input_mat <- data.frame(ranks = gene_ranks$rank, FoldChange = abs(gene_ranks$logFC), name = "AD_vs_CTRL")
# simulated.de.genes<-data.frame(ranks=ranks,
# FoldChange=foldChange,
# name="Simulated")

expressed.genes.df<-NULL
#Iterate over each count matrix
for(name in names(count.matrix.example)){
count.matrix<-count.matrix.example[[name]]
#Create an annotation file (here containing only one cell type, but can be more)
annot.df<-data.frame(individual=paste0("S",rep(1:14,length.out=ncol(count.matrix))),
cell.type=rep("default_ct",ncol(count.matrix)))
#Reformat count matrix into pseudobulk matrix
pseudo.bulk<-create.pseudobulk(count.matrix,annot.df)
#Calculate expressed genes in the pseudobulk matrix
expressed.genes<-calculate.gene.counts(pseudo.bulk,min.counts=3, perc.indiv=0.5)
#Get the number of expressed genes
num.expressed.genes<-nrow(expressed.genes)
#Save expressed genes
expressed.genes.df<-rbind(expressed.genes.df,
data.frame(matrix=name,
num.cells=ncol(count.matrix),
expressed.genes=num.expressed.genes))
}
print(expressed.genes.df)

gene_array <- array(logcounts(sce), dim = c(nrow(sce), length(sce$groups), 4), dimnames = c(list(gene.id = rownames(sce), indiv.id = sce$groups, ct.id = rep("EC_Vuln", times = 4))))
expressed_genes <- calculate.gene.counts(gene_array, min.counts = 0)

power<-power.general.withDoublets(nSamples=8,nCells=1500,readDepth=25000,
ct.freq=0.02150421,type="de",
ref.study=input_mat,
ref.study.name="Simulated",
samplesPerLane=1,
read.umi.fit = scPower::read.umi.fit[
read.umi.fit$type=="10X_PBMC_1",],
gamma.mixed.fits = scPower::gamma.mixed.fits,
ct="CD14+ Monocytes",
disp.fun.param=scPower::disp.fun.param,
mappingEfficiency = 0.8,
min.UMI.counts = 3,
perc.indiv.expr = 0.5,
sign.threshold = 0.05,
MTmethod="FDR")

print(power)
```
