---
title:
  'Simulation Analysis - `r unlist(strsplit(getwd(), "/"))[length(unlist(strsplit(getwd(), "/"))) - 2]`'
author:
  - name: "Emir Turkes [emir.turkes@eturkes.com]"
  - name: "UK Dementia Research Institute at UCL"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(
    inputFile,
    encoding = encoding,
    output_file = file.path(
      "..", "..", "results",
      unlist(strsplit(getwd(), "/"))[length(unlist(strsplit(getwd(), "/")))], "overlap.html"
    )
  )})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of the [Tau Vulnerability Project](https://github.com/eturkes/tau-vulnerability).*

The data here is derived from @`r unlist(strsplit(getwd(), "/"))[length(unlist(strsplit(getwd(), "/")))]` and will be referenced using the name ``r unlist(strsplit(getwd(), "/"))[length(unlist(strsplit(getwd(), "/")))]``.

```{r, boilerplate}
# Load in necessary boilerplate and libraries.
# --------------------------------------------

#    This file is part of tau-vulnerability.
#    Copyright (C) 2019-2021  Emir Turkes, UK DRI at UCL, Columbia University Medical Center
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at emir.turkes@eturkes.com

# These should be checked per document.
# -------------------------------------
options(stringsAsFactors = FALSE)
packages <- c(
  "conflicted", "liger", "GSVA", "limma"
)
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))
source(file.path("..", "utils.R"))

`%notin%` <- Negate(`%in%`)
# -------------------------------------

# Everything else in this chunk remains generally unchanged.
# ----------------------------------------------------------
analysis_no <- 1
data_name <- unlist(strsplit(getwd(), "/"))[6] # Name of dataset.
assets_dir <- file.path("..", "..", "assets") # Backed up data.

# Unique cache directory for each analysis number.
# ------------------------------------------------
cache_dir <- file.path("..", "..", "cache", data_name, paste0("0", analysis_no))
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

knitr::opts_chunk$set(dpi = 300)
# ------------------------------------------------
# ----------------------------------------------------------
```

# Analysis

```{r}
gene_set_name <- "GO"

# Load and filter gene sets.
# --------------------------
gene_sets_orig <- getGmt(
  file.path(
      "..", "..", "..", "..",
      "assets", "gene-sets", paste0(organism, ".", gene_set_name, ".ENSG.gmt")
  )
)
rds <- file.path(cache_dir, paste0(gene_set_name, "_gene_sets.rds"))
if (file.exists(rds)) {
  gene_sets <- readRDS(rds)
} else {
  gene_sets <- gene_sets_orig
  gene_sets <- filterGeneSets(gene_sets, 10, 500)
  for (i in seq(length(gene_sets@.Data))) {
    go_id <- gene_sets[[i]]@setName
    suppressWarnings(gene_sets[[i]]@setName <- gene_sets[[i]]@shortDescription)
    suppressWarnings(gene_sets[[i]]@shortDescription <- go_id)
  }
  saveRDS(gene_sets, rds)
}
# --------------------------

data("org.Hs.GO2Symbol.list")
universe <- unique(unlist(org.Hs.GO2Symbol.list))
gs <- org.Hs.GO2Symbol.list[[1]]
names(org.Hs.GO2Symbol.list)[1]

Nsamples <- 100
Mgenes <- length(universe)
mat <- matrix(rnorm(Nsamples * Mgenes, 5, 10), Mgenes, Nsamples)
colnames(mat) <- paste0('sample', 1:Nsamples)
rownames(mat) <- universe
# let half the samples be in one biological state and the other half a different one
# simulate differential expression for genes in the geneset
mat[gs, 1:round(Nsamples/2)] <- rnorm(length(gs)*round(Nsamples/2), 10, 10)
# we can visualize this weak differential expression visually in a heatmap
# visualize weakly differentially expressed genes and another 50 genes
vi <- c(gs, universe[1:50])
# label supposedly differentially expressed genes
heatmap(mat[vi,], Rowv=NA, Colv=NA, scale="none",
col=colorRampPalette(c("blue", "white", "red"))(100),
RowSideColors = rainbow(2)[as.factor(vi %in% gs)])

# run differential expression analysis
vals <- sapply(1:nrow(mat), function(i) {
pv <- t.test(mat[i, 1:round(Nsamples/2)], mat[i, round(Nsamples/2+1):Nsamples])$p.val
pv
})
names(vals) <- rownames(mat)
vals <- -log10(vals)
# look at -log10(p values) for genes that are supposedly differentially expressed
barplot(sort(vals[gs], decreasing=TRUE), ylim=c(0, 10))
# multiple testing correction line
bonf <- function(a, n) { 1 - (1-a) ** (1/n) }
abline(h = -log10(bonf(0.05, nrow(mat))), col="red")

# Run GSVA on pseudo-bulk counts.
# -------------------------------
gsva <- gsva(mat, org.Hs.GO2Symbol.list, method = "ssgsea", ssgsea.norm = FALSE)
colnames(gsva) <- sce$groups
# -------------------------------

# Fit model on pseudo-bulk GSVA results.
# --------------------------------------
design <- model.matrix(~ 0 + sce$idents + sce$patient)
colnames(design) <- c(names(idents), "patient2", "patient7")
fit <- lmFit(gsva, design)
contrast_mat <- makeContrasts(BA9_L45_EX_RORB_NFT-BA9_L45_EX_RORB_normal, levels = design)
cont_fit <- eBayes(contrasts.fit(fit, contrast_mat))
tests <- decideTests(cont_fit, p.value = 5e-2)
tests_up <- tests[tests[ , 1] == 1, ]
tests_down <- tests[tests[ , 1] == -1, ]
results <- topTable(cont_fit, number = Inf)

up <- results[rownames(results) %in% rownames(tests_up), ]
down <- results[rownames(results) %in% rownames(tests_down), ]
all <- rbind(up, down)
if (length(all) > 0) {
  all <- all[order(-all$B), ]
}
gsva_list_pseudobulk <- list(all, up, down)
names(gsva_list_pseudobulk) <- c(
  "All DE", paste0("Upregulated in ", names(idents)[1]),
  paste0("Downregulated in ", names(idents)[2])
)
# --------------------------------------

# Fit a strict model on pseudo-bulk GSVA results.
# -----------------------------------------------
design <- model.matrix(~ 0 + sce$idents + sce$patient)
colnames(design) <- c(names(idents), "patient2", "patient7")
fit <- lmFit(gsva, design)
contrast_mat <- makeContrasts(BA9_L45_EX_RORB_NFT-BA9_L45_EX_RORB_normal, levels = design)
cont_fit <- eBayes(contrasts.fit(fit, contrast_mat))
tests <- decideTests(cont_fit, p.value = 1e-2)
tests_up <- tests[tests[ , 1] == 1, ]
tests_down <- tests[tests[ , 1] == -1, ]
results <- topTable(cont_fit, number = Inf)

up <- results[rownames(results) %in% rownames(tests_up), ]
down <- results[rownames(results) %in% rownames(tests_down), ]
all <- rbind(up, down)
if (length(all) > 0) {
  all <- all[order(-all$B), ]
}
gsva_list_pseudobulk_strict <- list(all, up, down)
names(gsva_list_pseudobulk_strict) <- c(
  "All DE", paste0("Upregulated in ", names(idents)[1]),
  paste0("Downregulated in ", names(idents)[2])
)
# -----------------------------------------------

# Fit a stricter model on pseudo-bulk GSVA results.
# -------------------------------------------------
design <- model.matrix(~ 0 + sce$idents + sce$patient)
colnames(design) <- c(names(idents), "patient2", "patient7")
fit <- lmFit(gsva, design)
contrast_mat <- makeContrasts(BA9_L45_EX_RORB_NFT-BA9_L45_EX_RORB_normal, levels = design)
cont_fit <- eBayes(contrasts.fit(fit, contrast_mat))
tests <- decideTests(cont_fit, p.value = 5e-3)
tests_up <- tests[tests[ , 1] == 1, ]
tests_down <- tests[tests[ , 1] == -1, ]
results <- topTable(cont_fit, number = Inf)

up <- results[rownames(results) %in% rownames(tests_up), ]
down <- results[rownames(results) %in% rownames(tests_down), ]
all <- rbind(up, down)
if (length(all) > 0) {
  all <- all[order(-all$B), ]
}
gsva_list_pseudobulk_stricter <- list(all, up, down)
names(gsva_list_pseudobulk_stricter) <- c(
  "All DE", paste0("Upregulated in ", names(idents)[1]),
  paste0("Downregulated in ", names(idents)[2])
)
# -------------------------------------------------

# Fit the strictest model on pseudo-bulk GSVA results.
# ----------------------------------------------------
design <- model.matrix(~ 0 + sce$idents + sce$patient)
colnames(design) <- c(names(idents), "patient2", "patient7")
fit <- lmFit(gsva, design)
contrast_mat <- makeContrasts(BA9_L45_EX_RORB_NFT-BA9_L45_EX_RORB_normal, levels = design)
cont_fit <- eBayes(contrasts.fit(fit, contrast_mat))
tests <- decideTests(cont_fit, p.value = 1e-3)
tests_up <- tests[tests[ , 1] == 1, ]
tests_down <- tests[tests[ , 1] == -1, ]
results <- topTable(cont_fit, number = Inf)

up <- results[rownames(results) %in% rownames(tests_up), ]
down <- results[rownames(results) %in% rownames(tests_down), ]
all <- rbind(up, down)
if (length(all) > 0) {
  all <- all[order(-all$B), ]
}
gsva_list_pseudobulk_strictest <- list(all, up, down)
names(gsva_list_pseudobulk_strictest) <- c(
  "All DE", paste0("Upregulated in ", names(idents)[1]),
  paste0("Downregulated in ", names(idents)[2])
)
```

# References

This is the concluding section of the document, where we output the `sessionInfo`, and create a bibliography for works cited.

```{r}
sessionInfo()
```
