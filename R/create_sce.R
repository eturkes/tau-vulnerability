#    This file is part of tau-vulnerability.
#    Copyright (C) 2019  Emir Turkes
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at eturkes@bu.edu

library(SingleCellExperiment)
library(scater)

create_sce_from_counts <- function(counts, colData, rowData = NULL) {
    if(is.null(rowData)) {
        sceset <- SingleCellExperiment(assays = list(counts = as.matrix(counts)),
                                       colData = colData)
    } else {
        sceset <- SingleCellExperiment(assays = list(counts = as.matrix(counts)),
                                       colData = colData,
                                       rowData = rowData)
    }
    # This function writes to the logcounts slot.
    exprs(sceset) <- log2(calculateCPM(sceset, use.size.factors = FALSE) + 1)
    # Use gene names as feature symbols.
    rowData(sceset)$feature_symbol <- rownames(sceset)
    # Remove features with duplicated names.
    if(is.null(rowData)) {
        sceset <- sceset[!duplicated(rowData(sceset)$feature_symbol), ]
    }
    # QC
    isSpike(sceset, "ERCC") <- grepl("^ERCC-", rownames(sceset))
    sceset <- calculateQCMetrics(sceset, feature_controls = list(
        "ERCC" = isSpike(sceset, "ERCC"))
        )
    return(sceset)
}

create_sce_from_normcounts <- function(normcounts, colData, rowData = NULL) {
    if(is.null(rowData)) {
        sceset <- SingleCellExperiment(assays = list(
            normcounts = as.matrix(normcounts)), colData = colData
            )
    } else {
        sceset <- SingleCellExperiment(assays = list(
            normcounts = as.matrix(normcounts)), colData = colData, rowData = rowData
            )
    }
    logcounts(sceset) <- log2(normcounts(sceset) + 1)
    # Use gene names as feature symbols.
    rowData(sceset)$feature_symbol <- rownames(sceset)
    # Remove features with duplicated names.
    if(is.null(rowData)) {
        sceset <- sceset[!duplicated(rowData(sceset)$feature_symbol), ]
    }
    # QC
    isSpike(sceset, "ERCC") <- grepl("^ERCC-", rownames(sceset))
    return(sceset)
}

create_sce_from_logcounts <- function(logcounts, colData, rowData = NULL) {
    if(is.null(rowData)) {
        sceset <- SingleCellExperiment(assays = list(logcounts = as.matrix(logcounts)),
                                       colData = colData)
    } else {
        sceset <- SingleCellExperiment(assays = list(logcounts = as.matrix(logcounts)),
                                       colData = colData,
                                       rowData = rowData)
    }
    # Use gene names as feature symbols.
    rowData(sceset)$feature_symbol <- rownames(sceset)
    # Remove features with duplicated names.
    if(is.null(rowData)) {
        sceset <- sceset[!duplicated(rowData(sceset)$feature_symbol), ]
    }
    # QC
    isSpike(sceset, "ERCC") <- grepl("^ERCC-", rownames(sceset))
    return(sceset)
}
