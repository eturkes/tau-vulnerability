#    This file is part of tau-vulnerability.
#    Copyright (C) 2019  Emir Turkes
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at eturkes@bu.edu

# Data
# http://genome-tech.ucsd.edu/ZhangLab/index.php/data/epigenomics-and-transcriptomics/sns/
# Lake et al. (2016) Neuronal subtypes and diversity revealed by single-nucleus RNA
# sequencing of the human brain. Science. 352 (6293): 1586-1590
# Prefrontal cortex - BA10
# Frontal cortex (eye fields) - BA8
# Auditory cortex (speech) - BA21
# Auditory cortex (Wernicke's area) - BA22
# Auditory cortex - BA41/42
# Visual cortex - BA17
# Problems: duplicate row names
# Human
x1 <- read.delim(
  "/tau-vulnerability/data/Lake-2016/Lake-2016_Gene_TPM.dat",
  "\t", header=F, stringsAsFactors=FALSE
)
ann <- read.table(
  "/tau-vulnerability/data/Lake-2016/Lake-2016_Gene_TPM_Sample-annotation.txt",
  header=T
)
gene_names <- x1[,1]
cell_names <- x1[1,]
cell_names <- as.character(unlist(cell_names))
cell_names <- cell_names[-1]
gene_names <- gene_names[-1]
x1 <- x1[-1,-1]
# Not log-transformed TPMs.
exclude <- duplicated(gene_names)
keep_cells <- cell_names %in% ann[,2]
x1 <- x1[, keep_cells]
cell_names <- cell_names[keep_cells]
colnames(x1) <- cell_names;
reorder <- order(colnames(x1))
x1 <- x1[, reorder]

# Annotations
ann <- ann[ann[,2] %in% colnames(x1),]
ann <- ann[order(ann[,2]),]
keep_source <- as.character(unlist(ann[,4])) %in% "BA10"
x1 <- x1[, keep_source]
ann <- ann[ann[,2] %in% colnames(x1),]
ann <- ann[order(ann[,2]),]
SOURCE <- as.character(unlist(ann[,4]))
BATCH <- as.character(unlist(ann[,4]))
SOURCE[SOURCE=="BA10"] <- "Prefrontal cortex"
TYPE <- as.character(unlist(ann[3]))
AGE <- rep("51yo", times=length(BATCH))
SAMPLE <- colnames(x1)
SAMPLE <- paste0("X", SAMPLE)
DATA <- apply(x1, 1, as.numeric)
DATA <- t(DATA)
colnames(DATA) <- colnames(x1)
DATA <- DATA[!exclude, ]
rownames(DATA) <- gene_names[!exclude]
ANN <- data.frame(sample=SAMPLE, species=rep("Homo sapiens", times=length(TYPE)),
                  cell_type=TYPE, source=SOURCE, age=AGE, batch=BATCH)
rownames(ANN) <- colnames(x1)

write.table(
  DATA,
  file="/tau-vulnerability/data/Lake-2016/Lake-2016_Gene_TPM-PFC-pivot.dat",
  quote=FALSE, sep="\t", col.names=NA, row.names=TRUE
)
write.table(
  ANN,
  file="/tau-vulnerability/data/Lake-2016/Lake-2016_Gene_TPM_Sample-annotation-PFC-pivot.txt",
  quote=FALSE, sep="\t", col.names=TRUE, row.names=FALSE
)
